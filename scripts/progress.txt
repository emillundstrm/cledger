# Ralph Progress Log
Started: Sun Feb  1 09:54:56 CET 2026

## Codebase Patterns
- Gradle wrapper uses Gradle 8.7 (8.14.4 has download issues with Java 17 SSL)
- AnalyticsService accepts LocalDate parameter for testability (overloaded getAnalytics(today) method)
- Use JPQL queries in repository for analytics aggregations instead of loading all entities into memory
- Backend uses 4-space indentation for Java code (per ARCHITECTURE.md)
- Test profile uses H2 in-memory DB with Flyway disabled and ddl-auto: create-drop
- Test resources at backend/src/test/resources/application.yml override main config
- Frontend uses Node 20 via nvm (nvm use 20); npm is not on PATH without nvm
- Frontend uses Tailwind CSS v4 with @tailwindcss/vite plugin (no tailwind.config.js needed)
- ShadCN v3 with Tailwind v4 uses CSS variables in src/index.css for theming
- Import alias @/ maps to src/ via tsconfig paths and vite resolve alias
- Vitest config is in separate vitest.config.ts (not merged into vite.config.ts)
- Frontend uses 4-space indentation (matches backend convention)
- Session entity uses public no-arg constructor (not protected) so tests can instantiate directly
- @ElementCollection with @CollectionTable maps session_types and session_pain_flags tables
- @DataJpaTest is the right annotation for repository-only tests (auto-configures H2 + JPA)
- Spring Boot 3.4+ uses @MockitoBean instead of deprecated @MockBean for test mocking
- Use @WebMvcTest(ControllerClass.class) for controller tests with MockMvc
- SessionResponse.fromEntity() is the standard pattern for entity-to-DTO conversion
- React Router v7 uses `react-router` package (not react-router-dom); BrowserRouter/MemoryRouter imported from "react-router"
- ShadCN auto-generated UI components trigger react-refresh/only-export-components lint error; disabled in eslint.config.js for src/components/ui/
- Page components live in src/pages/, layout components in src/components/layout/
- Use MemoryRouter with initialEntries for testing routed components in Vitest
- @tanstack/react-query is the standard for data fetching; QueryClientProvider wraps BrowserRouter in App.tsx
- API types live in src/api/types.ts; fetch functions in src/api/sessions.ts
- For testing react-query components: create QueryClient with retry:false, wrap in QueryClientProvider + MemoryRouter
- Mock API modules with vi.mock("@/api/sessions") and vi.mocked() for typed mocks
- ResizeObserver polyfill required in test/setup.ts for Radix UI components (ToggleGroup, Popover, etc.)
- SessionForm component is reusable for create and edit — accepts initialData, onSubmit, onCancel, submitLabel props
- ShadCN AlertDialog is installed for confirmation dialogs (delete, destructive actions)
- For edit pages with route params, use useParams<{ id: string }>() and enable query with `enabled: !!id`
- date-fns `format()` is used for date formatting in the form; installed as dependency of react-day-picker
- @testing-library/user-event is needed for simulating user interactions (clicks, typing) in form tests
- When multiple charts share week labels, use getAllByText in tests instead of getByText to avoid duplicate element errors
- cmdk (ShadCN Command) requires scrollIntoView polyfill in test/setup.ts for jsdom
- ShadCN Popover+Command pattern with shouldFilter={false} and manual filtering works for combobox autocomplete
- When vi.resetAllMocks() is used in beforeEach, re-set mock return values there (not just in vi.mock factory)
- Venue autocomplete uses fetchVenues query in SessionForm; tests that render SessionForm need fetchVenues in their mock
- Session injuries use @OneToMany with CascadeType.ALL + orphanRemoval=true (replaced @ElementCollection painFlags)
- When SessionForm adds a new useQuery hook, ALL test files that render it need the corresponding mock (e.g., fetchInjuryLocations)
- InjuryLocationController follows same pattern as VenueController — simple controller using SessionRepository directly
- Recharts charts don't render SVG content in jsdom (zero width/height) — test chart containers via data-slot="chart" attribute, not chart text content
- ShadCN Chart uses ChartConfig to map data keys to labels and CSS variable colors (e.g., color: "var(--chart-1)")
- MCP server uses @modelcontextprotocol/sdk v1.25+ with Zod 4; import z from "zod" and McpServer from "@modelcontextprotocol/sdk/server/mcp.js"
- MCP server uses stdio transport (StdioServerTransport) for Claude Desktop compatibility
- MCP server project uses ESM (type: "module" in package.json) with Node16 module resolution
---

## 2026-02-01 - US-001
- What was implemented: Spring Boot 3.5.0 backend project scaffold with Gradle build
- Files changed:
  - backend/ (entire project scaffold from Spring Initializr)
  - backend/build.gradle - Spring Web, Data JPA, PostgreSQL, Flyway, H2 (test)
  - backend/src/main/resources/application.yml - PostgreSQL config (localhost:5432/cledger)
  - backend/src/main/java/com/cledger/controller/HealthController.java - GET /api/health
  - backend/src/test/java/com/cledger/controller/HealthControllerTest.java - WebMvcTest for health endpoint
  - backend/src/test/resources/application.yml - H2 test config
- **Learnings for future iterations:**
  - Spring Initializr now requires Boot 3.5.0+ (3.4.x no longer available)
  - Gradle 8.14.4 download fails with Java 17 SSL issues; using 8.7 from cache works
  - @WebMvcTest is preferred for controller-only tests (no DB needed)
  - CledgerApplicationTests with @SpringBootTest uses H2 for context loading tests
---

## 2026-02-01 - US-002
- What was implemented: React frontend project with Vite, TypeScript, Tailwind CSS v4, and ShadCN UI
- Files changed:
  - frontend/ (entire Vite + React + TypeScript scaffold)
  - frontend/vite.config.ts - Tailwind v4 plugin, path alias, /api proxy to localhost:8080
  - frontend/vitest.config.ts - Vitest config with jsdom environment
  - frontend/tsconfig.json - Added @/ path alias
  - frontend/tsconfig.app.json - Added @/ path alias
  - frontend/src/index.css - Tailwind v4 import with ShadCN theme variables
  - frontend/src/App.tsx - Placeholder page with CLedger title
  - frontend/src/App.test.tsx - Basic render tests
  - frontend/src/test/setup.ts - Vitest setup with jest-dom matchers
  - frontend/src/lib/utils.ts - ShadCN utility (cn function)
  - frontend/components.json - ShadCN configuration
- **Learnings for future iterations:**
  - Tailwind v4 uses @import "tailwindcss" instead of @tailwind directives
  - ShadCN init requires import alias configured in tsconfig before running
  - Use `npx shadcn@latest init -d` for default ShadCN setup
  - Vitest v4 works with separate vitest.config.ts using vitest/config defineConfig
  - Must load nvm before any npm/npx command: `export NVM_DIR="$HOME/.nvm" && . "$NVM_DIR/nvm.sh" && nvm use 20`
---

## 2026-02-01 - US-003
- What was implemented: Database schema for training sessions with Flyway migration, JPA entity, and Spring Data repository
- Files changed:
  - backend/src/main/resources/db/migration/V1__create_sessions_tables.sql - Flyway migration for sessions, session_types, session_pain_flags tables
  - backend/src/main/java/com/cledger/entity/Session.java - JPA entity with @ElementCollection for types and pain flags
  - backend/src/main/java/com/cledger/repository/SessionRepository.java - Spring Data JPA repository
  - backend/src/test/java/com/cledger/repository/SessionRepositoryTest.java - Repository tests (save, retrieve, delete with element collections)
- **Learnings for future iterations:**
  - Session entity constructor must be public (not protected) for test instantiation
  - @DataJpaTest auto-configures H2 + JPA for repository tests without needing @SpringBootTest
  - @ElementCollection with @CollectionTable correctly maps join tables (session_types, session_pain_flags)
  - @PrePersist/@PreUpdate callbacks handle created_at/updated_at automatically
---

## 2026-02-01 - US-004
- What was implemented: REST API for session CRUD (GET all, GET by id, POST, PUT, DELETE)
- Files changed:
  - backend/build.gradle - Added spring-boot-starter-validation dependency
  - backend/src/main/java/com/cledger/dto/SessionRequest.java - Request DTO with Jakarta validation annotations
  - backend/src/main/java/com/cledger/dto/SessionResponse.java - Response DTO with fromEntity() factory method
  - backend/src/main/java/com/cledger/service/SessionService.java - Business logic with domain validation for enum values
  - backend/src/main/java/com/cledger/controller/SessionController.java - REST endpoints with exception handlers
  - backend/src/test/java/com/cledger/service/SessionServiceTest.java - Unit tests for service logic (12 tests)
  - backend/src/test/java/com/cledger/controller/SessionControllerTest.java - WebMvcTest for controller endpoints (10 tests)
- **Learnings for future iterations:**
  - Use @Valid on @RequestBody for Jakarta Bean Validation (NotNull, NotBlank, NotEmpty)
  - Domain validation (valid enum values) done in service layer, not annotations
  - @ExceptionHandler on controller handles SessionNotFoundException (404) and InvalidSessionException (400)
  - MethodArgumentNotValidException handler needed for @Valid failures to return structured 400 errors
  - @MockitoBean (Spring Boot 3.4+) replaces deprecated @MockBean
---

## 2026-02-01 - US-005
- What was implemented: Frontend app shell with top navigation bar and React Router routing
- Files changed:
  - frontend/package.json - Added react-router dependency
  - frontend/eslint.config.js - Added rule override for ShadCN UI component exports
  - frontend/src/App.tsx - Replaced placeholder with BrowserRouter and route definitions
  - frontend/src/App.test.tsx - Updated tests for routed layout (7 tests)
  - frontend/src/components/layout/AppLayout.tsx - Top nav with CLedger title, Sessions and Dashboard links, Outlet for route content
  - frontend/src/components/ui/button.tsx - ShadCN Button component (added via CLI)
  - frontend/src/pages/SessionsPage.tsx - Placeholder sessions list page
  - frontend/src/pages/NewSessionPage.tsx - Placeholder new session page
  - frontend/src/pages/EditSessionPage.tsx - Placeholder edit session page
  - frontend/src/pages/DashboardPage.tsx - Placeholder dashboard page
- **Learnings for future iterations:**
  - React Router v7 package is just `react-router` (not react-router-dom)
  - BrowserRouter, Routes, Route, Navigate, useLocation all from "react-router"
  - MemoryRouter with initialEntries is the way to test routed components
  - ShadCN CLI output triggers react-refresh lint errors; need eslint override for src/components/ui/
  - Use <Route element={<Layout />}> with <Outlet /> for nested layout routing
---

## 2026-02-01 - US-006
- What was implemented: Frontend session timeline list with week grouping, fetching from API
- Files changed:
  - frontend/package.json - Added @tanstack/react-query dependency
  - frontend/src/api/types.ts - Session TypeScript interface matching backend DTO
  - frontend/src/api/sessions.ts - fetchSessions() function for GET /api/sessions
  - frontend/src/App.tsx - Added QueryClientProvider wrapping BrowserRouter
  - frontend/src/pages/SessionsPage.tsx - Full implementation with week grouping, session cards, badges, loading/error/empty states
  - frontend/src/pages/SessionsPage.test.tsx - 9 tests covering loading, empty, error, rendering, week grouping, and navigation
  - frontend/src/components/ui/card.tsx - ShadCN Card component (added via CLI)
  - frontend/src/components/ui/badge.tsx - ShadCN Badge component (added via CLI)
- **Learnings for future iterations:**
  - @tanstack/react-query QueryClient must be created outside App component to avoid re-creation on re-renders
  - For testing react-query components, create a fresh QueryClient per test with retry:false to avoid flaky tests
  - vi.mock() must be called before vi.mocked() imports; hoisting makes this work but keep the pattern consistent
  - groupByWeek uses Map to preserve insertion order (sessions already sorted by date desc from API)
  - Append "T00:00:00" to date strings before `new Date()` to avoid timezone offset issues
---

## 2026-02-01 - US-007
- What was implemented: Frontend session logging form with all required fields, date picker, type toggles, radio selectors, optional fields, pain flag checkboxes, and API submission
- Files changed:
  - frontend/package.json - Added @radix-ui/react-radio-group, @radix-ui/react-label, @radix-ui/react-checkbox, @radix-ui/react-popover, @radix-ui/react-toggle, @radix-ui/react-toggle-group, react-day-picker, date-fns, @testing-library/user-event
  - frontend/src/api/types.ts - Added SessionRequest interface and constant arrays for session types, intensity, performance, productivity, pain flag values
  - frontend/src/api/sessions.ts - Added createSession() function for POST /api/sessions
  - frontend/src/components/SessionForm.tsx - Reusable session form component with all fields, defaults, and validation
  - frontend/src/pages/NewSessionPage.tsx - Full implementation with mutation, error handling, and navigation
  - frontend/src/components/SessionForm.test.tsx - 15 tests for form rendering, interaction, defaults, pre-filling, and submission
  - frontend/src/pages/NewSessionPage.test.tsx - 4 tests for page rendering, API calls, and error states
  - frontend/src/test/setup.ts - Added ResizeObserver polyfill for Radix UI components in jsdom
  - frontend/src/components/ui/ - Added 9 ShadCN components (toggle-group, radio-group, input, textarea, label, checkbox, popover, toggle, calendar)
- **Learnings for future iterations:**
  - Radix UI components (ToggleGroup, Popover) require ResizeObserver which jsdom doesn't have — must polyfill in test setup
  - ShadCN CLI may fail with SSL errors when installing deps; run npm install separately first, then retry shadcn add
  - SessionForm is designed as a reusable component accepting initialData for edit mode (US-008 can reuse it)
  - date-fns format() is available since react-day-picker depends on it
  - ToggleGroup with type="multiple" returns string[] via onValueChange — maps directly to session types
  - Submit button should be disabled when required fields (types) are empty for good UX
  - @testing-library/user-event must be installed separately from @testing-library/react
---

## 2026-02-01 - US-008
- What was implemented: Frontend session edit form with pre-filled data, update, delete with confirmation dialog
- Files changed:
  - frontend/src/api/sessions.ts - Added fetchSession(), updateSession(), deleteSession() API functions
  - frontend/src/pages/EditSessionPage.tsx - Full implementation with useQuery for loading, useMutation for update/delete, AlertDialog for delete confirmation
  - frontend/src/pages/EditSessionPage.test.tsx - 9 tests covering loading, error, pre-fill, update, delete confirmation, and navigation
  - frontend/src/components/ui/alert-dialog.tsx - ShadCN AlertDialog component (added via CLI)
  - scripts/prd.json - Marked US-008 as passes: true
- **Learnings for future iterations:**
  - SessionForm reuse worked seamlessly — just pass initialData with Session fields mapped to SessionRequest
  - ShadCN AlertDialog works well for destructive action confirmations; trigger + content pattern
  - In tests with multiple buttons sharing the same name (e.g., "Delete" trigger + "Delete" confirm), use getAllByRole and pick the last one for the dialog action
  - useParams<{ id: string }>() with `enabled: !!id` in useQuery prevents query from firing without a route param
---

## 2026-02-01 - US-009
- What was implemented: Backend analytics endpoint (GET /api/analytics) with session stats, pain flag counts, and weekly session counts
- Files changed:
  - backend/src/main/java/com/cledger/dto/AnalyticsResponse.java - Response DTO with nested PainFlagCount and WeeklySessionCount classes
  - backend/src/main/java/com/cledger/repository/SessionRepository.java - Added JPQL queries for counting, date lookups, and pain flag aggregation
  - backend/src/main/java/com/cledger/service/AnalyticsService.java - Analytics computation with testable LocalDate parameter
  - backend/src/main/java/com/cledger/controller/AnalyticsController.java - GET /api/analytics endpoint
  - backend/src/test/java/com/cledger/service/AnalyticsServiceTest.java - 7 unit tests for analytics computation
  - backend/src/test/java/com/cledger/controller/AnalyticsControllerTest.java - 2 controller tests
- **Learnings for future iterations:**
  - Accept LocalDate as parameter in service methods to make analytics tests deterministic (avoid LocalDate.now() in tests)
  - JPQL queries with @ElementCollection joins work for aggregation (e.g., JOIN s.painFlags pf ... GROUP BY pf)
  - Use Object[] return type for JPQL queries with multiple select expressions (e.g., SELECT pf, COUNT(...))
  - ISO week start can be computed with TemporalAdjusters.previousOrSame(DayOfWeek.MONDAY)
---

## 2026-02-01 - US-010
- What was implemented: Frontend analytics dashboard with stat cards, pain flag summary, and weekly session bar chart (tests added)
- Files changed:
  - frontend/src/pages/DashboardPage.test.tsx - 8 tests covering loading, error, stat cards, pain flags, weekly chart, empty states
  - scripts/prd.json - Marked US-010 as passes: true
- **Learnings for future iterations:**
  - DashboardPage, api/types.ts (Analytics interface), and api/analytics.ts (fetchAnalytics) were already implemented in previous iterations as unstaged changes
  - When testing components with duplicate numeric text (e.g., stat values appearing in multiple places), use className filtering with getAllByText instead of getByText
  - Bar chart week labels use toLocaleDateString("en-US", { month: "short", day: "numeric" }) — test assertions need to match (e.g., "Dec 8", "Jan 26")
---

## 2026-02-01 - US-011
- What was implemented: Performance and productivity trend analytics — backend computes weekly averages, frontend displays as bar charts
- Files changed:
  - backend/src/main/java/com/cledger/dto/AnalyticsResponse.java - Added WeeklyTrend inner class, performanceTrend and productivityTrend fields
  - backend/src/main/java/com/cledger/service/AnalyticsService.java - Added computeWeeklyTrend(), mapPerformanceToNumber(), mapProductivityToNumber() methods
  - backend/src/test/java/com/cledger/service/AnalyticsServiceTest.java - Added 5 tests for trend computation (8 weeks, null averages, correct mapping)
  - frontend/src/api/types.ts - Added WeeklyTrend interface, added performanceTrend/productivityTrend to Analytics
  - frontend/src/pages/DashboardPage.tsx - Added TrendChart component and two trend cards (performance + productivity)
  - frontend/src/pages/DashboardPage.test.tsx - Updated mock data, added 3 tests for trend display, fixed existing test for duplicate week labels
  - scripts/prd.json - Marked US-011 as passes: true
- **Learnings for future iterations:**
  - When multiple charts share the same week date labels, tests must use getAllByText instead of getByText to avoid "found multiple elements" errors
  - Java switch expressions (case "weak" -> 1) work well for enum-like string mapping
  - Reusing findByDateBetween query avoids adding new repository methods when you already have sessions loaded
  - TrendChart height calculation maps 1-3 scale to 0-100% using (value - min) / (max - min) * 100
  - Nullable Double in Java serializes to JSON null, which maps to TypeScript number | null
---

## 2026-02-01 - US-012
- What was implemented: Venue field for sessions with autocomplete from previously used venues
- Files changed:
  - backend/src/main/resources/db/migration/V2__add_venue_to_sessions.sql - Flyway migration adding venue column
  - backend/src/main/java/com/cledger/entity/Session.java - Added venue field with getter/setter
  - backend/src/main/java/com/cledger/dto/SessionRequest.java - Added venue optional field
  - backend/src/main/java/com/cledger/dto/SessionResponse.java - Added venue field with fromEntity mapping
  - backend/src/main/java/com/cledger/service/SessionService.java - Added venue to applyRequestToEntity
  - backend/src/main/java/com/cledger/repository/SessionRepository.java - Added findDistinctVenues() JPQL query
  - backend/src/main/java/com/cledger/controller/VenueController.java - New GET /api/venues endpoint
  - backend/src/test/java/com/cledger/service/SessionServiceTest.java - Added 2 venue tests
  - backend/src/test/java/com/cledger/controller/VenueControllerTest.java - 2 tests for venue endpoint
  - frontend/src/api/types.ts - Added venue to Session and SessionRequest interfaces
  - frontend/src/api/sessions.ts - Added fetchVenues() function
  - frontend/src/components/SessionForm.tsx - Added venue combobox with Popover+Command autocomplete
  - frontend/src/components/SessionForm.test.tsx - Updated to wrap in QueryClientProvider, added 3 venue tests
  - frontend/src/components/ui/command.tsx - ShadCN Command component (new)
  - frontend/src/components/ui/dialog.tsx - ShadCN Dialog component (dependency of Command)
  - frontend/src/pages/SessionsPage.tsx - Shows venue with "@ venue" in session rows
  - frontend/src/pages/SessionsPage.test.tsx - Added venue to mock data, added venue display test
  - frontend/src/pages/EditSessionPage.tsx - Added venue to initialData mapping
  - frontend/src/pages/EditSessionPage.test.tsx - Added venue to mock data, fetchVenues mock
  - frontend/src/pages/NewSessionPage.test.tsx - Added fetchVenues mock
  - frontend/src/test/setup.ts - Added scrollIntoView polyfill for cmdk
  - scripts/prd.json - Marked US-012 as passes: true
- **Learnings for future iterations:**
  - cmdk (Command component) uses scrollIntoView internally which jsdom doesn't have — must polyfill in test/setup.ts
  - ShadCN Command with shouldFilter={false} allows manual filtering for combobox patterns where free text is needed
  - When SessionForm gains a useQuery dependency (like fetchVenues), all tests rendering SessionForm must wrap in QueryClientProvider
  - vi.resetAllMocks() in beforeEach clears mock implementations set in vi.mock factory — re-set in beforeEach
  - VenueController is a simple controller that directly uses SessionRepository (no service layer needed for a simple distinct query)
---

## 2026-02-01 - US-013
- What was implemented: Flexible pain/injury logging replacing fixed pain flags with free-form injury entries (location + optional note)
- Files changed:
  - backend/src/main/resources/db/migration/V3__replace_pain_flags_with_injuries.sql - Drops session_pain_flags, creates session_injuries table
  - backend/src/main/java/com/cledger/entity/SessionInjury.java - New JPA entity for injuries
  - backend/src/main/java/com/cledger/entity/Session.java - Replaced @ElementCollection painFlags with @OneToMany injuries
  - backend/src/main/java/com/cledger/dto/SessionRequest.java - Added InjuryRequest inner class, injuries list field
  - backend/src/main/java/com/cledger/dto/SessionResponse.java - Added InjuryResponse inner class, injuries list field
  - backend/src/main/java/com/cledger/service/SessionService.java - Handles injury create/update with orphanRemoval, validates injury locations
  - backend/src/main/java/com/cledger/repository/SessionRepository.java - Added countInjuryLocationsByDateBetween, findDistinctInjuryLocations JPQL queries
  - backend/src/main/java/com/cledger/service/AnalyticsService.java - Updated to use new injuries table for painFlagsLast30Days
  - backend/src/main/java/com/cledger/controller/InjuryLocationController.java - New GET /api/injury-locations endpoint
  - backend/src/test/java/com/cledger/controller/InjuryLocationControllerTest.java - 2 tests for injury location endpoint
  - backend/src/test/java/com/cledger/service/SessionServiceTest.java - Added injury tests (blank location, null injuries, persistence, free-form)
  - backend/src/test/java/com/cledger/service/AnalyticsServiceTest.java - Updated mocks to use countInjuryLocationsByDateBetween
  - backend/src/test/java/com/cledger/controller/SessionControllerTest.java - Updated to use injuries in mock data
  - backend/src/test/java/com/cledger/repository/SessionRepositoryTest.java - Updated to use SessionInjury entities
  - frontend/src/api/types.ts - Added InjuryResponse, InjuryRequest interfaces; replaced painFlags with injuries in Session/SessionRequest
  - frontend/src/api/sessions.ts - Added fetchInjuryLocations() function
  - frontend/src/components/SessionForm.tsx - Replaced pain flag checkboxes with dynamic injury entries (InjuryEntryRow with combobox autocomplete)
  - frontend/src/components/SessionForm.test.tsx - Updated tests for injuries section (add/remove, mock fetchInjuryLocations)
  - frontend/src/pages/SessionsPage.tsx - Shows injury location badges (destructive variant) instead of pain flag badges
  - frontend/src/pages/SessionsPage.test.tsx - Updated mock data from painFlags to injuries
  - frontend/src/pages/EditSessionPage.tsx - Maps injuries in initialData
  - frontend/src/pages/EditSessionPage.test.tsx - Updated mock data, added fetchInjuryLocations mock
  - frontend/src/pages/NewSessionPage.test.tsx - Added fetchInjuryLocations mock, updated mock response
  - frontend/src/pages/DashboardPage.tsx - Updated "Pain Flags" label to "Injuries"
  - frontend/src/pages/DashboardPage.test.tsx - Updated test assertions for "Injuries" labels
  - scripts/prd.json - Marked US-013 as passes: true
- **Learnings for future iterations:**
  - When replacing @ElementCollection with @OneToMany, use CascadeType.ALL + orphanRemoval=true so the parent manages the child lifecycle
  - session.getInjuries().clear() triggers orphan removal on update; then add new injuries with setSession() to maintain bidirectional relationship
  - JPQL queries on @OneToMany join with JOIN s.injuries i syntax (not JOIN s.painFlags)
  - When SessionForm adds a new useQuery dependency (e.g., fetchInjuryLocations), ALL test files that render SessionForm or pages containing it need the mock added
  - Test files that reference the Session type must be updated when fields change (painFlags -> injuries) — TypeScript catches type mismatches but not extra properties in object literals assigned to type
  - The Popover+Command combobox pattern is reusable — InjuryEntryRow reuses the exact same approach as venue autocomplete
---

## 2026-02-01 - US-015
- What was implemented: Added 'other' as a valid session type for non-climbing training
- Files changed:
  - backend/src/main/java/com/cledger/service/SessionService.java - Added "other" to VALID_TYPES set
  - frontend/src/api/types.ts - Added "other" to SESSION_TYPES const array
  - scripts/prd.json - Marked US-015 as passes: true
- **Learnings for future iterations:**
  - Adding a new session type requires only two changes: backend VALID_TYPES and frontend SESSION_TYPES constant
  - No migration needed since session_types table stores arbitrary varchar values
  - The SessionForm toggle buttons and SessionsPage badges render dynamically from the SESSION_TYPES array, so no template changes needed
---

## 2026-02-01 - US-016
- What was implemented: Removed hard attempts tracking from the entire stack
- Files changed:
  - backend/src/main/resources/db/migration/V4__drop_hard_attempts.sql - Flyway migration to drop hard_attempts column
  - backend/src/main/java/com/cledger/entity/Session.java - Removed hardAttempts field and getter/setter
  - backend/src/main/java/com/cledger/dto/SessionRequest.java - Removed hardAttempts field and getter/setter
  - backend/src/main/java/com/cledger/dto/SessionResponse.java - Removed hardAttempts field, getter, and fromEntity mapping
  - backend/src/main/java/com/cledger/service/SessionService.java - Removed setHardAttempts from applyRequestToEntity
  - backend/src/test/java/com/cledger/repository/SessionRepositoryTest.java - Removed hardAttempts from test data and assertions
  - backend/src/test/java/com/cledger/service/SessionServiceTest.java - Removed setHardAttempts from test setup
  - backend/src/test/java/com/cledger/controller/SessionControllerTest.java - Removed setHardAttempts from test helpers
  - frontend/src/api/types.ts - Removed hardAttempts from Session and SessionRequest interfaces
  - frontend/src/components/SessionForm.tsx - Removed hardAttempts state, form field, and submit mapping; changed grid from 3-col to 2-col
  - frontend/src/pages/EditSessionPage.tsx - Removed hardAttempts from initialData mapping
  - frontend/src/components/SessionForm.test.tsx - Removed hardAttempts from initialData and assertions
  - frontend/src/pages/SessionsPage.test.tsx - Removed hardAttempts from mock session data
  - frontend/src/pages/EditSessionPage.test.tsx - Removed hardAttempts from mock session and assertions
  - frontend/src/pages/NewSessionPage.test.tsx - Removed hardAttempts from mock response
  - scripts/prd.json - Marked US-016 as passes: true
- **Learnings for future iterations:**
  - Removing a field requires changes in: entity, DTOs, service, frontend types, form component, edit page mapping, and all tests that use mock data
  - The optional fields grid layout should be updated when number of fields changes (3-col to 2-col)
  - Analytics endpoint (hardSessionsLast7Days) uses intensity field, not hard_attempts — so no analytics changes needed
---

## 2026-02-01 - US-017
- What was implemented: Color-coded badges for intensity, performance, and productivity on session timeline cards
- Files changed:
  - frontend/src/pages/SessionsPage.tsx - Added intensityColor, performanceColor, productivityColor helper functions; replaced plain text spans with Badge components using conditional Tailwind classes
  - frontend/src/pages/SessionsPage.test.tsx - Added 3 tests verifying correct color classes for all intensity/performance/productivity values
  - scripts/prd.json - Marked US-017 as passes: true
- **Learnings for future iterations:**
  - ShadCN Badge accepts className prop to override default variant styles — use this for custom color coding
  - Tailwind bg-opacity pattern (e.g., bg-green-600/20 with text-green-700) creates subtle tinted badges that work well in both light and dark mode
  - title attribute on badges allows testing with getAllByTitle for grouped elements
  - Text labels remain visible alongside colors for accessibility compliance
---

## 2026-02-01 - US-018
- What was implemented: Upgraded dashboard charts from CSS-based to ShadCN Chart (Recharts) — bar chart for weekly sessions, line charts for performance/productivity trends
- Files changed:
  - frontend/package.json - Added recharts dependency (via shadcn chart)
  - frontend/src/components/ui/chart.tsx - ShadCN Chart component (new, added via CLI)
  - frontend/src/pages/DashboardPage.tsx - Replaced CSS bar charts (WeeklyChart, TrendChart) with Recharts components (WeeklySessionsChart using BarChart, TrendLineChart using LineChart) wrapped in ChartContainer with ChartConfig
  - frontend/src/pages/DashboardPage.test.tsx - Updated chart tests to verify chart container presence (data-slot="chart") instead of looking for text content inside charts (Recharts doesn't render in jsdom)
  - scripts/prd.json - Marked US-018 as passes: true
- **Learnings for future iterations:**
  - ShadCN Chart wraps Recharts in a ChartContainer with ChartConfig for theming via CSS variables
  - Recharts ResponsiveContainer renders with zero width/height in jsdom, so no SVG chart content appears — test chart containers via `data-slot="chart"` attribute
  - ChartConfig maps data keys (e.g., "count", "average") to display labels and CSS variable colors (e.g., "var(--chart-1)")
  - Chart CSS variables (--chart-1 through --chart-5) are already defined in index.css from ShadCN init
  - Use `accessibilityLayer` prop on BarChart/LineChart for built-in accessibility
  - LineChart with `connectNulls={false}` breaks lines at null data points (weeks with no sessions)
---

## 2026-02-01 - US-019
- What was implemented: Dark mode with blue-gray theme — dark class on HTML root, custom dark CSS variables with blue-gray tones
- Files changed:
  - frontend/index.html - Added class="dark" to <html> element, updated title to "CLedger"
  - frontend/src/index.css - Updated .dark CSS variables to use oklch with blue hue (250-260) for backgrounds, borders, inputs, primary, and ring colors
  - frontend/src/test/dark-mode.test.ts - 3 tests verifying dark class on HTML, blue-gray CSS variables, and dark background lightness
  - scripts/prd.json - Marked US-019 as passes: true
- **Learnings for future iterations:**
  - ShadCN dark mode works by adding `class="dark"` to the `<html>` element — the `@custom-variant dark` in index.css maps to `.dark *` selector
  - Setting dark class in static index.html prevents light-mode flash on page load (no JS needed)
  - oklch color space makes it easy to add blue tones to grays: keep lightness/chroma low and set hue to ~260 for slate-blue
  - Existing components with `dark:` Tailwind prefixes (e.g., color-coded badges) work automatically with the dark class
  - Primary color shifted from neutral gray to blue accent (oklch hue 250) for visual identity in dark mode
---

## 2026-02-02 - US-020
- What was implemented: MCP server for LLM-based training coach access with 7 tools
- Files changed:
  - mcp-server/package.json - Project config with @modelcontextprotocol/sdk, TypeScript, ESM
  - mcp-server/tsconfig.json - TypeScript config targeting ES2022 with Node16 module resolution
  - mcp-server/src/types.ts - TypeScript interfaces matching backend DTOs (SessionResponse, AnalyticsResponse, etc.)
  - mcp-server/src/api.ts - HTTP client class (CledgerApi) wrapping all CLedger REST API endpoints
  - mcp-server/src/index.ts - Main MCP server with 7 tools: list_sessions, get_session, list_injuries, get_analytics, log_session, log_injury, get_training_summary
  - mcp-server/README.md - Setup instructions and Claude Desktop configuration snippet
  - scripts/prd.json - Marked US-020 as passes: true
- **Learnings for future iterations:**
  - @modelcontextprotocol/sdk v1.25+ bundles Zod 4; import { z } from "zod" works directly
  - McpServer from "@modelcontextprotocol/sdk/server/mcp.js" provides the high-level tool() API
  - StdioServerTransport from "@modelcontextprotocol/sdk/server/stdio.js" handles stdin/stdout communication
  - The deprecated tool() method still works and is simpler than registerTool() for basic cases
  - MCP tools return { content: [{ type: "text", text: string }] } format
  - For injuries (which are embedded in sessions), the log_injury tool fetches existing session, appends the injury, and PUTs the updated session
  - get_training_summary is the key coaching tool — combines recent sessions + analytics in one call
  - Date filtering for list_sessions and list_injuries is done client-side since the backend API doesn't support query params for date ranges
---
