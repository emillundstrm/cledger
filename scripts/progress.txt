# Ralph Progress Log
Started: Sun Feb  1 09:54:56 CET 2026

## Codebase Patterns
- Frontend uses Node 20 via nvm (nvm use 20); npm is not on PATH without nvm
- Frontend uses Tailwind CSS v4 with @tailwindcss/vite plugin (no tailwind.config.js needed)
- ShadCN v3 with Tailwind v4 uses CSS variables in src/index.css for theming
- Import alias @/ maps to src/ via tsconfig paths and vite resolve alias
- Vitest config is in separate vitest.config.ts (not merged into vite.config.ts)
- Frontend uses 4-space indentation
- React Router v7 uses `react-router` package (not react-router-dom); BrowserRouter/MemoryRouter imported from "react-router"
- ShadCN auto-generated UI components trigger react-refresh/only-export-components lint error; disabled in eslint.config.js for src/components/ui/
- Page components live in src/pages/, layout components in src/components/layout/
- Use MemoryRouter with initialEntries for testing routed components in Vitest
- @tanstack/react-query is the standard for data fetching; QueryClientProvider wraps BrowserRouter in App.tsx
- API types live in src/api/types.ts; fetch functions in src/api/sessions.ts
- For testing react-query components: create QueryClient with retry:false, wrap in QueryClientProvider + MemoryRouter
- Mock API modules with vi.mock("@/api/sessions") and vi.mocked() for typed mocks
- ResizeObserver polyfill required in test/setup.ts for Radix UI components (ToggleGroup, Popover, etc.)
- SessionForm component is reusable for create and edit — accepts initialData, onSubmit, onCancel, submitLabel props
- ShadCN AlertDialog is installed for confirmation dialogs (delete, destructive actions)
- For edit pages with route params, use useParams<{ id: string }>() and enable query with `enabled: !!id`
- date-fns `format()` is used for date formatting in the form; installed as dependency of react-day-picker
- @testing-library/user-event is needed for simulating user interactions (clicks, typing) in form tests
- When multiple charts share week labels, use getAllByText in tests instead of getByText to avoid duplicate element errors
- cmdk (ShadCN Command) requires scrollIntoView polyfill in test/setup.ts for jsdom
- ShadCN Popover+Command pattern with shouldFilter={false} and manual filtering works for combobox autocomplete
- When vi.resetAllMocks() is used in beforeEach, re-set mock return values there (not just in vi.mock factory)
- Venue autocomplete uses fetchVenues query in SessionForm; tests that render SessionForm need fetchVenues in their mock
- When SessionForm adds a new useQuery hook, ALL test files that render it need the corresponding mock (e.g., fetchInjuryLocations)
- Recharts charts don't render SVG content in jsdom (zero width/height) — test chart containers via data-slot="chart" attribute, not chart text content
- ShadCN Chart uses ChartConfig to map data keys to labels and CSS variable colors (e.g., color: "var(--chart-1)")
- When adding new analytics RPC functions, update 3 places: frontend analytics.ts + types.ts, MCP server api.ts + types.ts
- MCP server uses @modelcontextprotocol/sdk v1.25+ with Zod 4; import z from "zod" and McpServer from "@modelcontextprotocol/sdk/server/mcp.js"
- MCP server uses stdio transport (StdioServerTransport) for Claude Desktop compatibility
- MCP server project uses ESM (type: "module" in package.json) with Node16 module resolution
- Supabase CLI commands must be run from frontend/ directory (where supabase/ config lives)
- Supabase migrations use YYYYMMDDHHMMSS timestamp prefix naming convention
- Use `npx supabase db reset` to apply migrations from scratch
- Local Supabase: API at :54321, DB at :54322, Studio at :54323
- Frontend env vars: VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY
- scripts/prd.md is a symlink to tasks/prd-supabase-migration.md — commit the target file (tasks/) not the symlink
- All Supabase tables need user_id UUID referencing auth.users(id) for RLS
- Sessions types stored as TEXT[] array column (not join table)
- RLS policies use `auth.uid() = user_id` pattern; UPDATE needs both USING and WITH CHECK clauses
- PostgREST returns 200 with empty array (not 403) when RLS filters out all rows on SELECT
- Supabase returns snake_case columns; use mapSessionRow/mapInjuryRow/mapInsightRow from types.ts for camelCase conversion
- Database row types (SessionRow, SessionInjuryRow, InsightRow) defined in types.ts for type-safe Supabase queries
- For mutations (create/update), use supabase.auth.getUser() to get user_id for inserts
- Batch-load related data (e.g., injuries for sessions) using .in() to avoid N+1 queries
- Analytics uses separate RPC functions called via Promise.all (functions defined in US-005 migration)
- Supabase client singleton lives in src/lib/supabase.ts; import { supabase } from "@/lib/supabase"
- Auth context (AuthProvider + useAuth) wraps the app; mock useAuth in tests that render AppLayout or auth-dependent components
- ProtectedRoute wraps AppLayout in App.tsx routes; unauthenticated users redirect to /login
- When adding useAuth to a component, ALL test files rendering that component must mock @/auth/AuthContext
- PostgreSQL generate_series with DATE needs INTERVAL step, not integer (e.g., INTERVAL '7 days')
- RPC functions use SECURITY INVOKER so auth.uid() resolves to the calling user; use STABLE for read-only functions
- LEFT JOIN + CASE must check s.id IS NULL to return NULL for empty weeks (otherwise ELSE default is used)
- MCP server env vars: CLEDGER_SUPABASE_URL, CLEDGER_SUPABASE_ANON_KEY, CLEDGER_EMAIL, CLEDGER_PASSWORD
- MCP server CledgerApi uses lazy auth (ensureAuthenticated) — authenticates on first API call, not at construction
- ShadCN Select renders selected value in multiple DOM elements — use getByLabelText + toHaveTextContent to test selected value (not getByText)
- ShadCN Tabs triggers use aria-selected (not aria-pressed) — test with `toHaveAttribute("aria-selected", "true")`
- GitHub Pages: Vite `base: '/cledger/'` + BrowserRouter `basename="/cledger"` + 404.html copy for SPA routing
- Production env vars (VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY) passed as GitHub Actions secrets
- tsconfig.app.json excludes test files (src/**/*.test.ts, src/**/*.test.tsx, src/test) to prevent build failures
---

## 2026-02-01 - US-001
- What was implemented: Spring Boot 3.5.0 backend project scaffold with Gradle build
- Files changed:
  - backend/ (entire project scaffold from Spring Initializr)
  - backend/build.gradle - Spring Web, Data JPA, PostgreSQL, Flyway, H2 (test)
  - backend/src/main/resources/application.yml - PostgreSQL config (localhost:5432/cledger)
  - backend/src/main/java/com/cledger/controller/HealthController.java - GET /api/health
  - backend/src/test/java/com/cledger/controller/HealthControllerTest.java - WebMvcTest for health endpoint
  - backend/src/test/resources/application.yml - H2 test config
- **Learnings for future iterations:**
  - Spring Initializr now requires Boot 3.5.0+ (3.4.x no longer available)
  - Gradle 8.14.4 download fails with Java 17 SSL issues; using 8.7 from cache works
  - @WebMvcTest is preferred for controller-only tests (no DB needed)
  - CledgerApplicationTests with @SpringBootTest uses H2 for context loading tests
---

## 2026-02-01 - US-002
- What was implemented: React frontend project with Vite, TypeScript, Tailwind CSS v4, and ShadCN UI
- Files changed:
  - frontend/ (entire Vite + React + TypeScript scaffold)
  - frontend/vite.config.ts - Tailwind v4 plugin, path alias, /api proxy to localhost:8080
  - frontend/vitest.config.ts - Vitest config with jsdom environment
  - frontend/tsconfig.json - Added @/ path alias
  - frontend/tsconfig.app.json - Added @/ path alias
  - frontend/src/index.css - Tailwind v4 import with ShadCN theme variables
  - frontend/src/App.tsx - Placeholder page with CLedger title
  - frontend/src/App.test.tsx - Basic render tests
  - frontend/src/test/setup.ts - Vitest setup with jest-dom matchers
  - frontend/src/lib/utils.ts - ShadCN utility (cn function)
  - frontend/components.json - ShadCN configuration
- **Learnings for future iterations:**
  - Tailwind v4 uses @import "tailwindcss" instead of @tailwind directives
  - ShadCN init requires import alias configured in tsconfig before running
  - Use `npx shadcn@latest init -d` for default ShadCN setup
  - Vitest v4 works with separate vitest.config.ts using vitest/config defineConfig
  - Must load nvm before any npm/npx command: `export NVM_DIR="$HOME/.nvm" && . "$NVM_DIR/nvm.sh" && nvm use 20`
---

## 2026-02-01 - US-003
- What was implemented: Database schema for training sessions with Flyway migration, JPA entity, and Spring Data repository
- Files changed:
  - backend/src/main/resources/db/migration/V1__create_sessions_tables.sql - Flyway migration for sessions, session_types, session_pain_flags tables
  - backend/src/main/java/com/cledger/entity/Session.java - JPA entity with @ElementCollection for types and pain flags
  - backend/src/main/java/com/cledger/repository/SessionRepository.java - Spring Data JPA repository
  - backend/src/test/java/com/cledger/repository/SessionRepositoryTest.java - Repository tests (save, retrieve, delete with element collections)
- **Learnings for future iterations:**
  - Session entity constructor must be public (not protected) for test instantiation
  - @DataJpaTest auto-configures H2 + JPA for repository tests without needing @SpringBootTest
  - @ElementCollection with @CollectionTable correctly maps join tables (session_types, session_pain_flags)
  - @PrePersist/@PreUpdate callbacks handle created_at/updated_at automatically
---

## 2026-02-01 - US-004
- What was implemented: REST API for session CRUD (GET all, GET by id, POST, PUT, DELETE)
- Files changed:
  - backend/build.gradle - Added spring-boot-starter-validation dependency
  - backend/src/main/java/com/cledger/dto/SessionRequest.java - Request DTO with Jakarta validation annotations
  - backend/src/main/java/com/cledger/dto/SessionResponse.java - Response DTO with fromEntity() factory method
  - backend/src/main/java/com/cledger/service/SessionService.java - Business logic with domain validation for enum values
  - backend/src/main/java/com/cledger/controller/SessionController.java - REST endpoints with exception handlers
  - backend/src/test/java/com/cledger/service/SessionServiceTest.java - Unit tests for service logic (12 tests)
  - backend/src/test/java/com/cledger/controller/SessionControllerTest.java - WebMvcTest for controller endpoints (10 tests)
- **Learnings for future iterations:**
  - Use @Valid on @RequestBody for Jakarta Bean Validation (NotNull, NotBlank, NotEmpty)
  - Domain validation (valid enum values) done in service layer, not annotations
  - @ExceptionHandler on controller handles SessionNotFoundException (404) and InvalidSessionException (400)
  - MethodArgumentNotValidException handler needed for @Valid failures to return structured 400 errors
  - @MockitoBean (Spring Boot 3.4+) replaces deprecated @MockBean
---

## 2026-02-01 - US-005
- What was implemented: Frontend app shell with top navigation bar and React Router routing
- Files changed:
  - frontend/package.json - Added react-router dependency
  - frontend/eslint.config.js - Added rule override for ShadCN UI component exports
  - frontend/src/App.tsx - Replaced placeholder with BrowserRouter and route definitions
  - frontend/src/App.test.tsx - Updated tests for routed layout (7 tests)
  - frontend/src/components/layout/AppLayout.tsx - Top nav with CLedger title, Sessions and Dashboard links, Outlet for route content
  - frontend/src/components/ui/button.tsx - ShadCN Button component (added via CLI)
  - frontend/src/pages/SessionsPage.tsx - Placeholder sessions list page
  - frontend/src/pages/NewSessionPage.tsx - Placeholder new session page
  - frontend/src/pages/EditSessionPage.tsx - Placeholder edit session page
  - frontend/src/pages/DashboardPage.tsx - Placeholder dashboard page
- **Learnings for future iterations:**
  - React Router v7 package is just `react-router` (not react-router-dom)
  - BrowserRouter, Routes, Route, Navigate, useLocation all from "react-router"
  - MemoryRouter with initialEntries is the way to test routed components
  - ShadCN CLI output triggers react-refresh lint errors; need eslint override for src/components/ui/
  - Use <Route element={<Layout />}> with <Outlet /> for nested layout routing
---

## 2026-02-01 - US-006
- What was implemented: Frontend session timeline list with week grouping, fetching from API
- Files changed:
  - frontend/package.json - Added @tanstack/react-query dependency
  - frontend/src/api/types.ts - Session TypeScript interface matching backend DTO
  - frontend/src/api/sessions.ts - fetchSessions() function for GET /api/sessions
  - frontend/src/App.tsx - Added QueryClientProvider wrapping BrowserRouter
  - frontend/src/pages/SessionsPage.tsx - Full implementation with week grouping, session cards, badges, loading/error/empty states
  - frontend/src/pages/SessionsPage.test.tsx - 9 tests covering loading, empty, error, rendering, week grouping, and navigation
  - frontend/src/components/ui/card.tsx - ShadCN Card component (added via CLI)
  - frontend/src/components/ui/badge.tsx - ShadCN Badge component (added via CLI)
- **Learnings for future iterations:**
  - @tanstack/react-query QueryClient must be created outside App component to avoid re-creation on re-renders
  - For testing react-query components, create a fresh QueryClient per test with retry:false to avoid flaky tests
  - vi.mock() must be called before vi.mocked() imports; hoisting makes this work but keep the pattern consistent
  - groupByWeek uses Map to preserve insertion order (sessions already sorted by date desc from API)
  - Append "T00:00:00" to date strings before `new Date()` to avoid timezone offset issues
---

## 2026-02-01 - US-007
- What was implemented: Frontend session logging form with all required fields, date picker, type toggles, radio selectors, optional fields, pain flag checkboxes, and API submission
- Files changed:
  - frontend/package.json - Added @radix-ui/react-radio-group, @radix-ui/react-label, @radix-ui/react-checkbox, @radix-ui/react-popover, @radix-ui/react-toggle, @radix-ui/react-toggle-group, react-day-picker, date-fns, @testing-library/user-event
  - frontend/src/api/types.ts - Added SessionRequest interface and constant arrays for session types, intensity, performance, productivity, pain flag values
  - frontend/src/api/sessions.ts - Added createSession() function for POST /api/sessions
  - frontend/src/components/SessionForm.tsx - Reusable session form component with all fields, defaults, and validation
  - frontend/src/pages/NewSessionPage.tsx - Full implementation with mutation, error handling, and navigation
  - frontend/src/components/SessionForm.test.tsx - 15 tests for form rendering, interaction, defaults, pre-filling, and submission
  - frontend/src/pages/NewSessionPage.test.tsx - 4 tests for page rendering, API calls, and error states
  - frontend/src/test/setup.ts - Added ResizeObserver polyfill for Radix UI components in jsdom
  - frontend/src/components/ui/ - Added 9 ShadCN components (toggle-group, radio-group, input, textarea, label, checkbox, popover, toggle, calendar)
- **Learnings for future iterations:**
  - Radix UI components (ToggleGroup, Popover) require ResizeObserver which jsdom doesn't have — must polyfill in test setup
  - ShadCN CLI may fail with SSL errors when installing deps; run npm install separately first, then retry shadcn add
  - SessionForm is designed as a reusable component accepting initialData for edit mode (US-008 can reuse it)
  - date-fns format() is available since react-day-picker depends on it
  - ToggleGroup with type="multiple" returns string[] via onValueChange — maps directly to session types
  - Submit button should be disabled when required fields (types) are empty for good UX
  - @testing-library/user-event must be installed separately from @testing-library/react
---

## 2026-02-01 - US-008
- What was implemented: Frontend session edit form with pre-filled data, update, delete with confirmation dialog
- Files changed:
  - frontend/src/api/sessions.ts - Added fetchSession(), updateSession(), deleteSession() API functions
  - frontend/src/pages/EditSessionPage.tsx - Full implementation with useQuery for loading, useMutation for update/delete, AlertDialog for delete confirmation
  - frontend/src/pages/EditSessionPage.test.tsx - 9 tests covering loading, error, pre-fill, update, delete confirmation, and navigation
  - frontend/src/components/ui/alert-dialog.tsx - ShadCN AlertDialog component (added via CLI)
  - scripts/prd.json - Marked US-008 as passes: true
- **Learnings for future iterations:**
  - SessionForm reuse worked seamlessly — just pass initialData with Session fields mapped to SessionRequest
  - ShadCN AlertDialog works well for destructive action confirmations; trigger + content pattern
  - In tests with multiple buttons sharing the same name (e.g., "Delete" trigger + "Delete" confirm), use getAllByRole and pick the last one for the dialog action
  - useParams<{ id: string }>() with `enabled: !!id` in useQuery prevents query from firing without a route param
---

## 2026-02-01 - US-009
- What was implemented: Backend analytics endpoint (GET /api/analytics) with session stats, pain flag counts, and weekly session counts
- Files changed:
  - backend/src/main/java/com/cledger/dto/AnalyticsResponse.java - Response DTO with nested PainFlagCount and WeeklySessionCount classes
  - backend/src/main/java/com/cledger/repository/SessionRepository.java - Added JPQL queries for counting, date lookups, and pain flag aggregation
  - backend/src/main/java/com/cledger/service/AnalyticsService.java - Analytics computation with testable LocalDate parameter
  - backend/src/main/java/com/cledger/controller/AnalyticsController.java - GET /api/analytics endpoint
  - backend/src/test/java/com/cledger/service/AnalyticsServiceTest.java - 7 unit tests for analytics computation
  - backend/src/test/java/com/cledger/controller/AnalyticsControllerTest.java - 2 controller tests
- **Learnings for future iterations:**
  - Accept LocalDate as parameter in service methods to make analytics tests deterministic (avoid LocalDate.now() in tests)
  - JPQL queries with @ElementCollection joins work for aggregation (e.g., JOIN s.painFlags pf ... GROUP BY pf)
  - Use Object[] return type for JPQL queries with multiple select expressions (e.g., SELECT pf, COUNT(...))
  - ISO week start can be computed with TemporalAdjusters.previousOrSame(DayOfWeek.MONDAY)
---

## 2026-02-01 - US-010
- What was implemented: Frontend analytics dashboard with stat cards, pain flag summary, and weekly session bar chart (tests added)
- Files changed:
  - frontend/src/pages/DashboardPage.test.tsx - 8 tests covering loading, error, stat cards, pain flags, weekly chart, empty states
  - scripts/prd.json - Marked US-010 as passes: true
- **Learnings for future iterations:**
  - DashboardPage, api/types.ts (Analytics interface), and api/analytics.ts (fetchAnalytics) were already implemented in previous iterations as unstaged changes
  - When testing components with duplicate numeric text (e.g., stat values appearing in multiple places), use className filtering with getAllByText instead of getByText
  - Bar chart week labels use toLocaleDateString("en-US", { month: "short", day: "numeric" }) — test assertions need to match (e.g., "Dec 8", "Jan 26")
---

## 2026-02-01 - US-011
- What was implemented: Performance and productivity trend analytics — backend computes weekly averages, frontend displays as bar charts
- Files changed:
  - backend/src/main/java/com/cledger/dto/AnalyticsResponse.java - Added WeeklyTrend inner class, performanceTrend and productivityTrend fields
  - backend/src/main/java/com/cledger/service/AnalyticsService.java - Added computeWeeklyTrend(), mapPerformanceToNumber(), mapProductivityToNumber() methods
  - backend/src/test/java/com/cledger/service/AnalyticsServiceTest.java - Added 5 tests for trend computation (8 weeks, null averages, correct mapping)
  - frontend/src/api/types.ts - Added WeeklyTrend interface, added performanceTrend/productivityTrend to Analytics
  - frontend/src/pages/DashboardPage.tsx - Added TrendChart component and two trend cards (performance + productivity)
  - frontend/src/pages/DashboardPage.test.tsx - Updated mock data, added 3 tests for trend display, fixed existing test for duplicate week labels
  - scripts/prd.json - Marked US-011 as passes: true
- **Learnings for future iterations:**
  - When multiple charts share the same week date labels, tests must use getAllByText instead of getByText to avoid "found multiple elements" errors
  - Java switch expressions (case "weak" -> 1) work well for enum-like string mapping
  - Reusing findByDateBetween query avoids adding new repository methods when you already have sessions loaded
  - TrendChart height calculation maps 1-3 scale to 0-100% using (value - min) / (max - min) * 100
  - Nullable Double in Java serializes to JSON null, which maps to TypeScript number | null
---

## 2026-02-01 - US-012
- What was implemented: Venue field for sessions with autocomplete from previously used venues
- Files changed:
  - backend/src/main/resources/db/migration/V2__add_venue_to_sessions.sql - Flyway migration adding venue column
  - backend/src/main/java/com/cledger/entity/Session.java - Added venue field with getter/setter
  - backend/src/main/java/com/cledger/dto/SessionRequest.java - Added venue optional field
  - backend/src/main/java/com/cledger/dto/SessionResponse.java - Added venue field with fromEntity mapping
  - backend/src/main/java/com/cledger/service/SessionService.java - Added venue to applyRequestToEntity
  - backend/src/main/java/com/cledger/repository/SessionRepository.java - Added findDistinctVenues() JPQL query
  - backend/src/main/java/com/cledger/controller/VenueController.java - New GET /api/venues endpoint
  - backend/src/test/java/com/cledger/service/SessionServiceTest.java - Added 2 venue tests
  - backend/src/test/java/com/cledger/controller/VenueControllerTest.java - 2 tests for venue endpoint
  - frontend/src/api/types.ts - Added venue to Session and SessionRequest interfaces
  - frontend/src/api/sessions.ts - Added fetchVenues() function
  - frontend/src/components/SessionForm.tsx - Added venue combobox with Popover+Command autocomplete
  - frontend/src/components/SessionForm.test.tsx - Updated to wrap in QueryClientProvider, added 3 venue tests
  - frontend/src/components/ui/command.tsx - ShadCN Command component (new)
  - frontend/src/components/ui/dialog.tsx - ShadCN Dialog component (dependency of Command)
  - frontend/src/pages/SessionsPage.tsx - Shows venue with "@ venue" in session rows
  - frontend/src/pages/SessionsPage.test.tsx - Added venue to mock data, added venue display test
  - frontend/src/pages/EditSessionPage.tsx - Added venue to initialData mapping
  - frontend/src/pages/EditSessionPage.test.tsx - Added venue to mock data, fetchVenues mock
  - frontend/src/pages/NewSessionPage.test.tsx - Added fetchVenues mock
  - frontend/src/test/setup.ts - Added scrollIntoView polyfill for cmdk
  - scripts/prd.json - Marked US-012 as passes: true
- **Learnings for future iterations:**
  - cmdk (Command component) uses scrollIntoView internally which jsdom doesn't have — must polyfill in test/setup.ts
  - ShadCN Command with shouldFilter={false} allows manual filtering for combobox patterns where free text is needed
  - When SessionForm gains a useQuery dependency (like fetchVenues), all tests rendering SessionForm must wrap in QueryClientProvider
  - vi.resetAllMocks() in beforeEach clears mock implementations set in vi.mock factory — re-set in beforeEach
  - VenueController is a simple controller that directly uses SessionRepository (no service layer needed for a simple distinct query)
---

## 2026-02-01 - US-013
- What was implemented: Flexible pain/injury logging replacing fixed pain flags with free-form injury entries (location + optional note)
- Files changed:
  - backend/src/main/resources/db/migration/V3__replace_pain_flags_with_injuries.sql - Drops session_pain_flags, creates session_injuries table
  - backend/src/main/java/com/cledger/entity/SessionInjury.java - New JPA entity for injuries
  - backend/src/main/java/com/cledger/entity/Session.java - Replaced @ElementCollection painFlags with @OneToMany injuries
  - backend/src/main/java/com/cledger/dto/SessionRequest.java - Added InjuryRequest inner class, injuries list field
  - backend/src/main/java/com/cledger/dto/SessionResponse.java - Added InjuryResponse inner class, injuries list field
  - backend/src/main/java/com/cledger/service/SessionService.java - Handles injury create/update with orphanRemoval, validates injury locations
  - backend/src/main/java/com/cledger/repository/SessionRepository.java - Added countInjuryLocationsByDateBetween, findDistinctInjuryLocations JPQL queries
  - backend/src/main/java/com/cledger/service/AnalyticsService.java - Updated to use new injuries table for painFlagsLast30Days
  - backend/src/main/java/com/cledger/controller/InjuryLocationController.java - New GET /api/injury-locations endpoint
  - backend/src/test/java/com/cledger/controller/InjuryLocationControllerTest.java - 2 tests for injury location endpoint
  - backend/src/test/java/com/cledger/service/SessionServiceTest.java - Added injury tests (blank location, null injuries, persistence, free-form)
  - backend/src/test/java/com/cledger/service/AnalyticsServiceTest.java - Updated mocks to use countInjuryLocationsByDateBetween
  - backend/src/test/java/com/cledger/controller/SessionControllerTest.java - Updated to use injuries in mock data
  - backend/src/test/java/com/cledger/repository/SessionRepositoryTest.java - Updated to use SessionInjury entities
  - frontend/src/api/types.ts - Added InjuryResponse, InjuryRequest interfaces; replaced painFlags with injuries in Session/SessionRequest
  - frontend/src/api/sessions.ts - Added fetchInjuryLocations() function
  - frontend/src/components/SessionForm.tsx - Replaced pain flag checkboxes with dynamic injury entries (InjuryEntryRow with combobox autocomplete)
  - frontend/src/components/SessionForm.test.tsx - Updated tests for injuries section (add/remove, mock fetchInjuryLocations)
  - frontend/src/pages/SessionsPage.tsx - Shows injury location badges (destructive variant) instead of pain flag badges
  - frontend/src/pages/SessionsPage.test.tsx - Updated mock data from painFlags to injuries
  - frontend/src/pages/EditSessionPage.tsx - Maps injuries in initialData
  - frontend/src/pages/EditSessionPage.test.tsx - Updated mock data, added fetchInjuryLocations mock
  - frontend/src/pages/NewSessionPage.test.tsx - Added fetchInjuryLocations mock, updated mock response
  - frontend/src/pages/DashboardPage.tsx - Updated "Pain Flags" label to "Injuries"
  - frontend/src/pages/DashboardPage.test.tsx - Updated test assertions for "Injuries" labels
  - scripts/prd.json - Marked US-013 as passes: true
- **Learnings for future iterations:**
  - When replacing @ElementCollection with @OneToMany, use CascadeType.ALL + orphanRemoval=true so the parent manages the child lifecycle
  - session.getInjuries().clear() triggers orphan removal on update; then add new injuries with setSession() to maintain bidirectional relationship
  - JPQL queries on @OneToMany join with JOIN s.injuries i syntax (not JOIN s.painFlags)
  - When SessionForm adds a new useQuery dependency (e.g., fetchInjuryLocations), ALL test files that render SessionForm or pages containing it need the mock added
  - Test files that reference the Session type must be updated when fields change (painFlags -> injuries) — TypeScript catches type mismatches but not extra properties in object literals assigned to type
  - The Popover+Command combobox pattern is reusable — InjuryEntryRow reuses the exact same approach as venue autocomplete
---

## 2026-02-01 - US-015
- What was implemented: Added 'other' as a valid session type for non-climbing training
- Files changed:
  - backend/src/main/java/com/cledger/service/SessionService.java - Added "other" to VALID_TYPES set
  - frontend/src/api/types.ts - Added "other" to SESSION_TYPES const array
  - scripts/prd.json - Marked US-015 as passes: true
- **Learnings for future iterations:**
  - Adding a new session type requires only two changes: backend VALID_TYPES and frontend SESSION_TYPES constant
  - No migration needed since session_types table stores arbitrary varchar values
  - The SessionForm toggle buttons and SessionsPage badges render dynamically from the SESSION_TYPES array, so no template changes needed
---

## 2026-02-01 - US-016
- What was implemented: Removed hard attempts tracking from the entire stack
- Files changed:
  - backend/src/main/resources/db/migration/V4__drop_hard_attempts.sql - Flyway migration to drop hard_attempts column
  - backend/src/main/java/com/cledger/entity/Session.java - Removed hardAttempts field and getter/setter
  - backend/src/main/java/com/cledger/dto/SessionRequest.java - Removed hardAttempts field and getter/setter
  - backend/src/main/java/com/cledger/dto/SessionResponse.java - Removed hardAttempts field, getter, and fromEntity mapping
  - backend/src/main/java/com/cledger/service/SessionService.java - Removed setHardAttempts from applyRequestToEntity
  - backend/src/test/java/com/cledger/repository/SessionRepositoryTest.java - Removed hardAttempts from test data and assertions
  - backend/src/test/java/com/cledger/service/SessionServiceTest.java - Removed setHardAttempts from test setup
  - backend/src/test/java/com/cledger/controller/SessionControllerTest.java - Removed setHardAttempts from test helpers
  - frontend/src/api/types.ts - Removed hardAttempts from Session and SessionRequest interfaces
  - frontend/src/components/SessionForm.tsx - Removed hardAttempts state, form field, and submit mapping; changed grid from 3-col to 2-col
  - frontend/src/pages/EditSessionPage.tsx - Removed hardAttempts from initialData mapping
  - frontend/src/components/SessionForm.test.tsx - Removed hardAttempts from initialData and assertions
  - frontend/src/pages/SessionsPage.test.tsx - Removed hardAttempts from mock session data
  - frontend/src/pages/EditSessionPage.test.tsx - Removed hardAttempts from mock session and assertions
  - frontend/src/pages/NewSessionPage.test.tsx - Removed hardAttempts from mock response
  - scripts/prd.json - Marked US-016 as passes: true
- **Learnings for future iterations:**
  - Removing a field requires changes in: entity, DTOs, service, frontend types, form component, edit page mapping, and all tests that use mock data
  - The optional fields grid layout should be updated when number of fields changes (3-col to 2-col)
  - Analytics endpoint (hardSessionsLast7Days) uses intensity field, not hard_attempts — so no analytics changes needed
---

## 2026-02-01 - US-017
- What was implemented: Color-coded badges for intensity, performance, and productivity on session timeline cards
- Files changed:
  - frontend/src/pages/SessionsPage.tsx - Added intensityColor, performanceColor, productivityColor helper functions; replaced plain text spans with Badge components using conditional Tailwind classes
  - frontend/src/pages/SessionsPage.test.tsx - Added 3 tests verifying correct color classes for all intensity/performance/productivity values
  - scripts/prd.json - Marked US-017 as passes: true
- **Learnings for future iterations:**
  - ShadCN Badge accepts className prop to override default variant styles — use this for custom color coding
  - Tailwind bg-opacity pattern (e.g., bg-green-600/20 with text-green-700) creates subtle tinted badges that work well in both light and dark mode
  - title attribute on badges allows testing with getAllByTitle for grouped elements
  - Text labels remain visible alongside colors for accessibility compliance
---

## 2026-02-01 - US-018
- What was implemented: Upgraded dashboard charts from CSS-based to ShadCN Chart (Recharts) — bar chart for weekly sessions, line charts for performance/productivity trends
- Files changed:
  - frontend/package.json - Added recharts dependency (via shadcn chart)
  - frontend/src/components/ui/chart.tsx - ShadCN Chart component (new, added via CLI)
  - frontend/src/pages/DashboardPage.tsx - Replaced CSS bar charts (WeeklyChart, TrendChart) with Recharts components (WeeklySessionsChart using BarChart, TrendLineChart using LineChart) wrapped in ChartContainer with ChartConfig
  - frontend/src/pages/DashboardPage.test.tsx - Updated chart tests to verify chart container presence (data-slot="chart") instead of looking for text content inside charts (Recharts doesn't render in jsdom)
  - scripts/prd.json - Marked US-018 as passes: true
- **Learnings for future iterations:**
  - ShadCN Chart wraps Recharts in a ChartContainer with ChartConfig for theming via CSS variables
  - Recharts ResponsiveContainer renders with zero width/height in jsdom, so no SVG chart content appears — test chart containers via `data-slot="chart"` attribute
  - ChartConfig maps data keys (e.g., "count", "average") to display labels and CSS variable colors (e.g., "var(--chart-1)")
  - Chart CSS variables (--chart-1 through --chart-5) are already defined in index.css from ShadCN init
  - Use `accessibilityLayer` prop on BarChart/LineChart for built-in accessibility
  - LineChart with `connectNulls={false}` breaks lines at null data points (weeks with no sessions)
---

## 2026-02-01 - US-019
- What was implemented: Dark mode with blue-gray theme — dark class on HTML root, custom dark CSS variables with blue-gray tones
- Files changed:
  - frontend/index.html - Added class="dark" to <html> element, updated title to "CLedger"
  - frontend/src/index.css - Updated .dark CSS variables to use oklch with blue hue (250-260) for backgrounds, borders, inputs, primary, and ring colors
  - frontend/src/test/dark-mode.test.ts - 3 tests verifying dark class on HTML, blue-gray CSS variables, and dark background lightness
  - scripts/prd.json - Marked US-019 as passes: true
- **Learnings for future iterations:**
  - ShadCN dark mode works by adding `class="dark"` to the `<html>` element — the `@custom-variant dark` in index.css maps to `.dark *` selector
  - Setting dark class in static index.html prevents light-mode flash on page load (no JS needed)
  - oklch color space makes it easy to add blue tones to grays: keep lightness/chroma low and set hue to ~260 for slate-blue
  - Existing components with `dark:` Tailwind prefixes (e.g., color-coded badges) work automatically with the dark class
  - Primary color shifted from neutral gray to blue accent (oklch hue 250) for visual identity in dark mode
---

## 2026-02-02 - US-020
- What was implemented: MCP server for LLM-based training coach access with 7 tools
- Files changed:
  - mcp-server/package.json - Project config with @modelcontextprotocol/sdk, TypeScript, ESM
  - mcp-server/tsconfig.json - TypeScript config targeting ES2022 with Node16 module resolution
  - mcp-server/src/types.ts - TypeScript interfaces matching backend DTOs (SessionResponse, AnalyticsResponse, etc.)
  - mcp-server/src/api.ts - HTTP client class (CledgerApi) wrapping all CLedger REST API endpoints
  - mcp-server/src/index.ts - Main MCP server with 7 tools: list_sessions, get_session, list_injuries, get_analytics, log_session, log_injury, get_training_summary
  - mcp-server/README.md - Setup instructions and Claude Desktop configuration snippet
  - scripts/prd.json - Marked US-020 as passes: true
- **Learnings for future iterations:**
  - @modelcontextprotocol/sdk v1.25+ bundles Zod 4; import { z } from "zod" works directly
  - McpServer from "@modelcontextprotocol/sdk/server/mcp.js" provides the high-level tool() API
  - StdioServerTransport from "@modelcontextprotocol/sdk/server/stdio.js" handles stdin/stdout communication
  - The deprecated tool() method still works and is simpler than registerTool() for basic cases
  - MCP tools return { content: [{ type: "text", text: string }] } format
  - For injuries (which are embedded in sessions), the log_injury tool fetches existing session, appends the injury, and PUTs the updated session
  - get_training_summary is the key coaching tool — combines recent sessions + analytics in one call
  - Date filtering for list_sessions and list_injuries is done client-side since the backend API doesn't support query params for date ranges
---

## 2026-02-02 - US-021
- What was implemented: Coach insights — full-stack feature with backend CRUD API, frontend UI with list/add/edit/delete views, and MCP server integration
- Files changed:
  - backend/src/main/resources/db/migration/V5__create_coach_insights_table.sql - Flyway migration for coach_insights table
  - backend/src/main/java/com/cledger/entity/CoachInsight.java - JPA entity with UUID PK, content, pinned, timestamps
  - backend/src/main/java/com/cledger/repository/CoachInsightRepository.java - Repository with findAllByOrderByPinnedDescUpdatedAtDesc
  - backend/src/main/java/com/cledger/dto/InsightRequest.java - Request DTO with @NotBlank content validation
  - backend/src/main/java/com/cledger/dto/InsightResponse.java - Response DTO with fromEntity pattern
  - backend/src/main/java/com/cledger/service/InsightService.java - CRUD service with InsightNotFoundException
  - backend/src/main/java/com/cledger/controller/InsightController.java - REST endpoints GET/POST/PUT/DELETE /api/insights
  - backend/src/test/java/com/cledger/service/InsightServiceTest.java - 8 unit tests for service logic
  - backend/src/test/java/com/cledger/controller/InsightControllerTest.java - 8 controller tests
  - frontend/src/api/types.ts - Added Insight and InsightRequest interfaces
  - frontend/src/api/insights.ts - API functions: fetchInsights, fetchInsight, createInsight, updateInsight, deleteInsight
  - frontend/src/pages/InsightsPage.tsx - Full page with list/add/edit views, InsightCard with expand/collapse, AlertDialog for delete
  - frontend/src/pages/InsightsPage.test.tsx - 11 tests covering loading, error, empty, list, add, edit, delete flows
  - frontend/src/App.tsx - Added /insights route
  - frontend/src/App.test.tsx - Added Insights nav link tests
  - frontend/src/components/layout/AppLayout.tsx - Added Insights nav item
  - mcp-server/src/types.ts - Added InsightResponse and InsightRequest interfaces
  - mcp-server/src/api.ts - Added listInsights, createInsight, updateInsight methods
  - mcp-server/src/index.ts - Added list_insights, add_insight, update_insight tools; updated get_training_summary with coachInsights
- **Learnings for future iterations:**
  - CoachInsight entity follows same pattern as Session: UUID PK, @PrePersist/@PreUpdate for timestamps
  - InsightService follows SessionService pattern closely but is simpler (no complex validation needed)
  - Frontend InsightsPage uses single-page state machine (list/add/edit) instead of separate routes — simpler for a CRUD page with few fields
  - AlertDialog for delete confirmation reuses the same ShadCN component pattern from EditSessionPage
  - When testing delete confirmation dialogs, use getAllByRole("button", { name: "Delete" }) and pick the last one for the dialog action button
  - MCP get_training_summary includes top 5 insights (already sorted by pinned desc, updated_at desc from backend) for coaching feedback loop
  - Spring Data JPA derived query method names (findAllByOrderByPinnedDescUpdatedAtDesc) handle multi-field sorting
- react-markdown renders markdown as React elements; custom CSS class (prose-insight) in index.css styles output for dark theme
---

## 2026-02-02 - US-022
- What was implemented: Markdown rendering in insight cards using react-markdown with dark theme styling
- Files changed:
  - frontend/package.json - Added react-markdown dependency
  - frontend/src/pages/InsightsPage.tsx - Imported ReactMarkdown, replaced plain text `<p>` in InsightCard with `<ReactMarkdown>` wrapped in prose-insight div
  - frontend/src/index.css - Added `.prose-insight` CSS class with styles for headings, lists, code, pre, strong, links, blockquotes matching dark theme
  - frontend/src/pages/InsightsPage.test.tsx - Added 2 tests: markdown renders as HTML (h2, strong, code tags verified), truncation works with long markdown content
  - scripts/prd.json - Marked US-022 as passes: true
- **Learnings for future iterations:**
  - react-markdown renders markdown as React elements by default — no dangerouslySetInnerHTML needed
  - Custom CSS class (prose-insight) works better than Tailwind prose plugin for fine-grained control over markdown styling with CSS variables
  - Truncation should be applied to raw markdown string before passing to ReactMarkdown (slice the string, not the rendered output)
  - react-markdown in jsdom renders actual HTML elements (h2, strong, code, etc.) so tests can verify tagName directly
  - The edit view textarea still accepts raw markdown text — no WYSIWYG editor needed per acceptance criteria
---

## 2026-02-04 - US-001 (Supabase Migration)
- What was implemented: Local Supabase instance setup with database schema migration
- Files changed:
  - frontend/supabase/migrations/20260204000000_initial_schema.sql - Single migration creating all 3 tables (sessions, session_injuries, coach_insights) with user_id, indexes, and updated_at triggers
  - frontend/.env - VITE_SUPABASE_URL and VITE_SUPABASE_ANON_KEY for local Supabase instance
- **Learnings for future iterations:**
  - Supabase CLI v2.75 uses "Publishable" and "Secret" keys in human-readable output, but JSON output (`-o json`) still has ANON_KEY and SERVICE_ROLE_KEY
  - Use `npx supabase db reset` to apply migrations from scratch (drops and recreates)
  - `npx supabase start` pulls Docker images on first run — can take several minutes
  - Sessions `types` column is TEXT[] array (replaces the old session_types join table)
  - All tables use gen_random_uuid() default for PKs, now() defaults for timestamps, and TIMESTAMPTZ (not TIMESTAMP)
  - Local Supabase demo anon key is safe to commit (it's a well-known demo JWT)
  - update_updated_at() trigger function shared across all tables for automatic updated_at management
  - Supabase migrations use timestamp prefix (YYYYMMDDHHMMSS) naming convention
---

## 2026-02-04 - US-002 (Supabase Migration)
- What was implemented: Row Level Security policies for all tables (sessions, session_injuries, coach_insights)
- Files changed:
  - frontend/supabase/migrations/20260204000001_enable_rls.sql - RLS enable + SELECT/INSERT/UPDATE/DELETE policies for all 3 tables
  - scripts/prd.md - Marked US-002 acceptance criteria as done
- **Learnings for future iterations:**
  - PostgREST returns HTTP 200 with empty array for SELECT when RLS filters out all rows (not 403)
  - PostgREST returns HTTP 204 for UPDATE/DELETE when RLS filters out rows (0 affected, not an error) — data is still safe
  - INSERT with wrong user_id returns HTTP 403 with "new row violates row-level security policy" error
  - UPDATE policies need both USING (for which rows to match) and WITH CHECK (for what the updated row must satisfy)
  - Use Supabase admin API (service role key + /auth/v1/admin/users) to create test users for RLS verification
  - `auth.uid()` in RLS policies automatically extracts the user ID from the JWT token
---

## 2026-02-04 - US-003 (Supabase Migration)
- What was implemented: Authentication with Supabase Auth — login page, auth context/provider, route protection, sign-out button
- Files changed:
  - frontend/package.json - Added @supabase/supabase-js dependency
  - frontend/src/lib/supabase.ts - Supabase client singleton initialization
  - frontend/src/auth/AuthContext.tsx - Auth context with session state, signIn, signOut; AuthProvider wraps the app
  - frontend/src/auth/ProtectedRoute.tsx - Route guard that redirects unauthenticated users to /login
  - frontend/src/auth/ProtectedRoute.test.tsx - 3 tests: loading state, redirect when unauthenticated, render when authenticated
  - frontend/src/pages/LoginPage.tsx - Login form with email/password fields, error display, loading state
  - frontend/src/pages/LoginPage.test.tsx - 6 tests: form fields, submit, error display, loading state
  - frontend/src/components/layout/AppLayout.tsx - Added Sign out button using useAuth().signOut
  - frontend/src/App.tsx - Added AuthProvider wrapper, LoginPage route, ProtectedRoute around AppLayout
  - frontend/src/App.test.tsx - Added useAuth mock, Sign out button test
- **Learnings for future iterations:**
  - Supabase auth.onAuthStateChange() handles session refresh automatically; getSession() initializes on mount
  - ProtectedRoute as a wrapper component (children pattern) works well with React Router layout routes
  - When AppLayout gains useAuth dependency, ALL existing test files that render AppLayout need the mock added
  - Login page doesn't need its own route protection — it's outside the ProtectedRoute wrapper
  - supabase.auth.signInWithPassword returns { error } with message property, not a thrown Error
  - No sign-up form needed — Supabase email+password auth works with manually invited users (dashboard invite link)
---

## 2026-02-04 - US-004 (Supabase Migration)
- What was implemented: Replaced all frontend fetch('/api/...') calls with Supabase JS client calls
- Files changed:
  - frontend/src/api/types.ts - Added SessionRow, SessionInjuryRow, InsightRow database row types; added mapSessionRow, mapInjuryRow, mapInsightRow mapping functions for snake_case to camelCase conversion
  - frontend/src/api/sessions.ts - Rewrote all 7 functions (fetchSessions, fetchSession, createSession, updateSession, deleteSession, fetchVenues, fetchInjuryLocations) to use Supabase client
  - frontend/src/api/insights.ts - Rewrote all 5 functions (fetchInsights, fetchInsight, createInsight, updateInsight, deleteInsight) to use Supabase client with coach_insights table
  - frontend/src/api/analytics.ts - Rewrote fetchAnalytics to call 6 separate Supabase RPC functions (sessions_this_week, hard_sessions_last_7_days, pain_flags_last_30_days, weekly_session_counts, performance_trend, productivity_trend)
  - scripts/prd.md - Marked US-004 acceptance criteria as done
- **Learnings for future iterations:**
  - Supabase returns snake_case columns; need explicit mapping functions (mapSessionRow etc.) to convert to camelCase for frontend types
  - Sessions and injuries are in separate tables — fetchSessions batch-loads injuries with `.in("session_id", sessionIds)` to avoid N+1 queries
  - For create/update mutations, supabase.auth.getUser() provides the user_id needed for inserts (RLS requires user_id to match auth.uid())
  - Injury update strategy: delete all existing injuries for the session, then insert new ones (simpler than diff-based update)
  - Venues and injury-locations use distinct queries via Set deduplication on the client side (Supabase doesn't have a native DISTINCT select)
  - Analytics uses 6 separate RPC calls via Promise.all — RPC functions will be created in US-005
  - daysSinceLastRestDay hardcoded to 0 per PRD (US-005 says it doesn't need to work)
  - React Query hooks (useQuery/useMutation) in page components didn't need any changes — they call the same exported functions with the same signatures
  - All 90 existing tests pass without modification since they mock the API modules (vi.mock("@/api/sessions") etc.)
---

## 2026-02-04 - US-012 (Supabase Migration)
- What was implemented: Post-login redirect to sessions page and login form lockdown during authentication
- Files changed:
  - frontend/src/pages/LoginPage.tsx - Added useNavigate for post-login redirect to /sessions, disabled email and password inputs during loading
  - frontend/src/pages/LoginPage.test.tsx - Added tests for navigation on success, input disabling during loading, form re-enable after error; mocked useNavigate
  - scripts/prd.md - Marked US-012 acceptance criteria as done
- **Learnings for future iterations:**
  - When mocking useNavigate from react-router, use vi.importActual to keep MemoryRouter working while overriding useNavigate
  - MemoryRouter internally uses useNavigate, so mocking it at module level can cause interference between tests — be careful with assertions about navigate NOT being called
  - On successful login, don't reset loading to false — navigate away instead to avoid flash of re-enabled form
  - On error, only reset loading in the error branch so the form stays locked until navigation or error display
---

## 2026-02-04 - US-005 (Supabase Migration)
- What was implemented: Analytics computation as 6 Supabase RPC functions (sessions_this_week, hard_sessions_last_7_days, pain_flags_last_30_days, weekly_session_counts, performance_trend, productivity_trend)
- Files changed:
  - frontend/supabase/migrations/20260204000002_analytics_rpc_functions.sql - 6 RPC functions matching the Java AnalyticsService logic
  - scripts/prd.md (-> tasks/prd-supabase-migration.md) - Marked US-005 acceptance criteria as done
- **Learnings for future iterations:**
  - PostgreSQL generate_series with DATE types requires INTERVAL step (e.g., INTERVAL '7 days'), not integer
  - LEFT JOIN with CASE expressions must handle NULL s.id explicitly — otherwise empty weeks get the ELSE default value instead of NULL
  - SECURITY INVOKER (default for SQL functions) ensures auth.uid() resolves to the calling user's JWT
  - date_trunc('week', CURRENT_DATE) returns ISO Monday-based weeks in PostgreSQL
  - RPC functions returning TABLE types are accessible via supabase.rpc() and return arrays
  - RPC functions returning scalar values (INTEGER) return the value directly
  - Frontend analytics.ts was already wired up in US-004 to call these exact RPC function names — no frontend changes needed
---

## 2026-02-04 - US-006 (Supabase Migration)
- What was implemented: Verified session form (create, edit, delete) works correctly with Supabase — no code changes needed since US-004 already rewired the API layer
- Files changed:
  - tasks/prd-supabase-migration.md - Marked US-006 acceptance criteria as done
- **Learnings for future iterations:**
  - US-004 (API layer rewrite) implicitly completed US-006 — the session form components (SessionForm, NewSessionPage, EditSessionPage) call the same exported API functions whose signatures didn't change
  - The delete-then-reinsert pattern for injuries in updateSession() works correctly with Supabase (no orphan issues since old injuries are explicitly deleted)
  - ON DELETE CASCADE on session_injuries.session_id handles cleanup when a session is deleted
  - All 92 frontend tests pass without any changes — mocking at the API module level means tests are backend-agnostic
---

## 2026-02-05 - US-007 (Supabase Migration)
- What was implemented: Migrated MCP server from HTTP-based Spring Boot API calls to direct Supabase client queries
- Files changed:
  - mcp-server/package.json - Added @supabase/supabase-js dependency
  - mcp-server/package-lock.json - Updated lock file with Supabase dependency tree
  - mcp-server/src/types.ts - Added database row types (SessionRow, SessionInjuryRow, InsightRow) and mapping functions (mapSessionRow, mapInjuryRow, mapInsightRow) for snake_case to camelCase conversion
  - mcp-server/src/api.ts - Completely rewritten: replaced HTTP fetch-based CledgerApi with Supabase client; constructor now takes supabaseUrl, anonKey, email, password; uses ensureAuthenticated() with signInWithPassword; all methods use supabase.from().select/insert/update/delete and supabase.rpc() for analytics
  - mcp-server/src/index.ts - Updated to read CLEDGER_SUPABASE_URL, CLEDGER_SUPABASE_ANON_KEY, CLEDGER_EMAIL, CLEDGER_PASSWORD env vars; validates all are present; passes to CledgerApi constructor
- **Learnings for future iterations:**
  - MCP server types.ts mirrors frontend types.ts pattern — database row types + mapping functions for snake_case to camelCase conversion
  - CledgerApi class uses lazy authentication (ensureAuthenticated) — authenticates on first API call, not at construction time
  - MCP server env vars use CLEDGER_ prefix (CLEDGER_SUPABASE_URL, CLEDGER_SUPABASE_ANON_KEY, CLEDGER_EMAIL, CLEDGER_PASSWORD) to distinguish from frontend VITE_ vars
  - The existing MCP server code was already partially migrated in working tree (unstaged changes from previous iteration) — this story committed the complete migration
  - MCP server analytics uses the same 6 RPC functions as the frontend (sessions_this_week, hard_sessions_last_7_days, etc.) via Promise.all
  - The injury update strategy (delete all + re-insert) is shared between frontend and MCP server — both use the same pattern
---

## 2026-02-05 - US-008 (Supabase Migration)
- What was implemented: Removed the entire Spring Boot backend and all references to it
- Files changed:
  - backend/ - Entire directory deleted (all Java source, Gradle build, Flyway migrations, tests)
  - frontend/vite.config.ts - Removed server.proxy configuration for /api -> localhost:8080
  - frontend/src/api/sessions.ts - Fixed pre-existing `let` -> `const` lint issue
  - ARCHITECTURE.md - Rewritten to reflect Supabase-based architecture (removed all Spring Boot/JPA/JUnit references)
  - mcp-server/README.md - Updated for Supabase env vars (replaced CLEDGER_API_URL with CLEDGER_SUPABASE_URL, CLEDGER_SUPABASE_ANON_KEY, CLEDGER_EMAIL, CLEDGER_PASSWORD)
  - .gitignore - Removed backend-specific entries (migrate.py, migration_inserts.sql)
  - scripts/progress.txt - Cleaned Codebase Patterns section to remove obsolete backend-specific patterns
  - tasks/prd-supabase-migration.md - Marked US-008 acceptance criteria as done
- **Learnings for future iterations:**
  - After removing the backend, the frontend and MCP server still work perfectly since they were already migrated to use Supabase directly
  - The pre-existing AuthContext.tsx react-refresh lint warning is expected and acceptable (exports both component and hook)
  - All 92 frontend tests continue to pass — they mock at the API module level, so they're backend-agnostic
  - When cleaning up Codebase Patterns, only remove patterns that are specific to deleted code; keep patterns that apply to remaining code
---

## 2026-02-05 - US-009 (Supabase Migration)
- What was implemented: GitHub Pages deployment configuration — Vite base path, BrowserRouter basename, GitHub Actions workflow, SPA routing via 404.html, and tsconfig fix for build
- Files changed:
  - frontend/vite.config.ts - Added `base: '/cledger/'` for GitHub Pages asset paths
  - frontend/src/App.tsx - Added `basename="/cledger"` to BrowserRouter for client-side routing under subpath
  - frontend/package.json - Updated build script to copy index.html to 404.html for SPA routing
  - frontend/index.html - Removed broken favicon reference (Vite doesn't rewrite static hrefs with base)
  - frontend/tsconfig.app.json - Excluded test files from build (pre-existing tsc errors in test files blocked `tsc -b`)
  - .github/workflows/deploy.yml - GitHub Actions workflow: checkout, setup Node 20, npm ci, build with secrets, upload-pages-artifact, deploy-pages
  - frontend/src/test/deploy-config.test.ts - 5 tests verifying Vite base, BrowserRouter basename, build script 404.html copy, workflow existence, and secrets usage
  - tasks/prd-supabase-migration.md - Marked code-related US-009 acceptance criteria as done
- **Learnings for future iterations:**
  - Vite `base` option rewrites JS/CSS asset paths in built HTML but does NOT rewrite static `<link href>` or other hardcoded paths — remove or use relative paths for public/ assets
  - BrowserRouter `basename` prop makes React Router operate under a subpath — all `<Link to>` and `useNavigate` calls are relative to the basename
  - Tests using MemoryRouter are NOT affected by BrowserRouter basename — they operate on raw paths
  - GitHub Pages SPA routing: copy index.html to 404.html so GitHub serves the app for all paths instead of a 404 page
  - GitHub Actions `actions/upload-pages-artifact@v3` + `actions/deploy-pages@v4` is the current pattern for Pages deployment
  - Production Supabase URL and anon key are passed as GitHub Actions secrets (VITE_SUPABASE_URL, VITE_SUPABASE_ANON_KEY) — set these in repo Settings > Secrets
  - tsconfig.app.json `include: ["src"]` includes test files; must add `exclude` for test patterns to prevent build failures from test-only imports (fs, path, global)
  - Remaining US-009 items require manual steps: push Supabase migrations to hosted project, configure Auth site URL, verify production functionality
---

## 2026-02-06 - US-013 (Supabase Migration)
- What was implemented: Mobile responsiveness fixes for header navigation and dashboard charts
- Files changed:
  - frontend/src/components/layout/AppLayout.tsx - Added lucide-react icons (CalendarDays, BarChart3, Lightbulb, LogOut) to nav items; labels use `hidden sm:inline` to show icons only on mobile; reduced gaps on small screens; added shrink-0 to prevent CLedger title and Sign out from shrinking
  - frontend/src/pages/DashboardPage.tsx - Added `min-w-0` to chart containers to allow them to shrink below intrinsic width; added `overflow-x-auto` to chart card content for graceful overflow; added `min-w-0` to trend chart cards; reduced chart tick font sizes and Y-axis widths for better small-screen fit
  - frontend/src/App.test.tsx - Updated tests to use `getByTitle` for nav links (since labels are now hidden spans); added tests verifying icons are present (svg elements); added tests verifying labels have `hidden sm:inline` classes
  - tasks/prd-supabase-migration.md - Marked US-013 acceptance criteria as done
- **Learnings for future iterations:**
  - lucide-react is already installed via ShadCN — use it for icon-only mobile nav patterns
  - Tailwind `hidden sm:inline` pattern shows text only at sm breakpoint and above, while icons remain visible at all sizes
  - For Recharts charts, `min-w-0` on ChartContainer allows ResponsiveContainer to shrink properly in flex/grid layouts
  - When nav links contain both icons and text, use `title` attribute for accessibility and testing; `getByTitle` is more reliable than `getByRole('link', { name })` when label text is hidden
  - YAxis `width` prop in Recharts controls the fixed width reserved for axis labels — reducing it helps on small screens
---

## 2026-02-06 - US-015 (Supabase Migration)
- What was implemented: Improved Insights card interaction — clicking card expands/collapses, separate edit button
- Files changed:
  - frontend/src/pages/InsightsPage.tsx - Modified InsightCard: clicking card now expands/collapses for long content (instead of triggering edit); added dedicated Edit button (ghost variant, subtle styling); changed "Show more/less" button to hint text "Click to expand/collapse"
  - frontend/src/pages/InsightsPage.test.tsx - Updated tests: changed "opens edit view when clicking an insight" to click Edit button instead of card; added "each insight card has an edit button" test; added tests for expand/collapse on card click; added test for collapse on second click
  - tasks/prd-supabase-migration.md - Marked US-015 acceptance criteria as done
- **Learnings for future iterations:**
  - When changing card click behavior, all tests that relied on clicking the card content must be updated to click the new button instead
  - Button variant="ghost" with text-muted-foreground is a subtle but discoverable pattern for secondary actions
  - For expandable cards, showing "Click to expand" hint instead of "Show more" button clarifies that the whole card is clickable
  - e.stopPropagation() on the edit button prevents the card's expand/collapse click handler from firing
---

## 2026-02-06 - US-014 (Supabase Migration)
- What was implemented: Removed "Days since rest" metric from dashboard and all daysSinceLastRestDay references
- Files changed:
  - frontend/src/pages/DashboardPage.tsx - Removed "Days Since Rest" card; changed stat cards grid from 3 columns to 2
  - frontend/src/pages/DashboardPage.test.tsx - Removed daysSinceLastRestDay from mockAnalytics; updated stat cards test to expect 2 values; added explicit test that "Days Since Rest" is not displayed
  - frontend/src/api/types.ts - Removed daysSinceLastRestDay from Analytics interface
  - frontend/src/api/analytics.ts - Removed daysSinceLastRestDay from fetchAnalytics return object
  - mcp-server/src/types.ts - Removed daysSinceLastRestDay from AnalyticsResponse interface
  - mcp-server/src/api.ts - Removed daysSinceLastRestDay from getAnalytics return object
  - mcp-server/src/index.ts - Removed daysSinceLastRestDay from get_training_summary overview object
  - tasks/prd-supabase-migration.md - Marked US-014 acceptance criteria as done
- **Learnings for future iterations:**
  - When removing a field from Analytics, update: types.ts, analytics.ts, DashboardPage.tsx, DashboardPage.test.tsx in frontend; types.ts, api.ts, index.ts in mcp-server
  - Test mock data must be updated to match interface changes — TypeScript catches mismatches on type annotations
  - When removing a stat card, consider updating grid column count (sm:grid-cols-3 → sm:grid-cols-2)
---

## 2026-02-06 - US-001 (Expanded Features)
- What was implemented: Calendar view for sessions — view toggle buttons (list/calendar), weekly calendar grid with abbreviated session types, venue display, today highlighting, and localStorage persistence
- Files changed:
  - frontend/src/pages/SessionsPage.tsx - Added CalendarView component with CSS grid layout (7 columns, one row per week), view toggle buttons (List/CalendarDays icons) left of "Log Session", localStorage-persisted view preference, abbreviated session type labels (B, R, H, S, etc.), venue display, today cell highlighting
  - frontend/src/pages/SessionsPage.test.tsx - Added 14 new tests across 2 new describe blocks: "View Toggle" (6 tests for toggle buttons, switching, localStorage persistence/restoration) and "Calendar View" (8 tests for day headers, week rows, type abbreviations, venue, links, no scores, empty cells, today highlighting). Added localStorage.clear() to beforeEach
  - tasks/prd-expanded-features.md - Marked US-001 acceptance criteria as done
- **Learnings for future iterations:**
  - lucide-react List and CalendarDays icons work well for view toggle buttons
  - Button size="icon-sm" (h-8) from ShadCN button variants works for compact icon toggles
  - CSS grid with grid-cols-7 is ideal for calendar week layout; gap-1 keeps cells readable
  - Session type abbreviation map (SESSION_TYPE_ABBREV) keeps calendar cells compact
  - In calendar view, sessions are ordered by date within each week (Mon-Sun), so the first edit link is the earliest date, not necessarily the first mock session
  - For tests with today's date, create sessions with dynamic todayStr and use findByText("Boulder") in list view before switching to calendar
  - toDateKey() helper avoids timezone issues by using manual YYYY-MM-DD formatting instead of toISOString()
  - aria-pressed attribute on toggle buttons provides accessibility state for testing
---

## 2026-02-06 - US-004 (Expanded Features)
- What was implemented: Dashboard chart layout improvements — Weekly Sessions and Weekly Training Load charts now displayed side by side on wider screens, matching the Performance/Productivity trend chart pairing
- Files changed:
  - frontend/src/pages/DashboardPage.tsx - Wrapped Weekly Sessions and Weekly Training Load cards in a `grid gap-4 sm:grid-cols-2` div with `min-w-0` on each card (matching the Performance/Productivity pattern)
  - frontend/src/pages/DashboardPage.test.tsx - Added 2 tests verifying side-by-side grid layout for both chart pairs (sessions+load and performance+productivity)
  - tasks/prd-expanded-features.md - Marked US-004 acceptance criteria as done
- **Learnings for future iterations:**
  - The `sm:grid-cols-2` + `min-w-0` pattern is the standard for side-by-side chart cards in DashboardPage
  - ShadCN Card v3 uses `data-slot="card"` attribute — use `.closest("[data-slot='card']")` to find the card element from a child in tests
  - When adding side-by-side layout, don't forget `min-w-0` on cards containing Recharts charts (allows them to shrink below intrinsic width)
---

## 2026-02-06 - US-003 (Expanded Features)
- What was implemented: Training load metric on dashboard — Supabase RPC functions for weekly training load calculation, summary card with trend indicator, bar chart for last 8 weeks
- Files changed:
  - frontend/supabase/migrations/20260206000000_training_load_rpc.sql - Two new RPC functions: weekly_training_load (returns load per week for 8 weeks) and current_week_training_load (scalar for current week)
  - frontend/src/api/types.ts - Added WeeklyTrainingLoad interface, added currentWeekTrainingLoad and weeklyTrainingLoad to Analytics interface
  - frontend/src/api/analytics.ts - Added calls to new RPC functions (current_week_training_load, weekly_training_load) via Promise.all
  - frontend/src/pages/DashboardPage.tsx - Added Training Load summary card (with trend indicator using TrendingUp/TrendingDown/Minus icons), WeeklyTrainingLoadChart (bar chart), LoadTrendIndicator component, getLoadTrend helper (>10% change = increasing/decreasing, otherwise stable), expanded stat grid from 2 to 3 columns
  - frontend/src/pages/DashboardPage.test.tsx - Updated mock analytics with training load data, updated stat cards test (3 values), updated chart container counts (4), added 5 new tests: training load chart, empty state, increasing/decreasing/stable trend indicators
  - mcp-server/src/types.ts - Added WeeklyTrainingLoad interface, added currentWeekTrainingLoad and weeklyTrainingLoad to AnalyticsResponse
  - mcp-server/src/api.ts - Added calls to new RPC functions in getAnalytics
  - mcp-server/src/index.ts - Added currentWeekTrainingLoad and weeklyTrainingLoad to get_training_summary overview
  - tasks/prd-expanded-features.md - Marked US-003 acceptance criteria as done
- **Learnings for future iterations:**
  - Training load formula: Load = duration_minutes × intensity_factor (easy=1, moderate=2, hard=3)
  - Sessions without duration_minutes are excluded via IS NOT NULL in the LEFT JOIN condition
  - Trend detection uses >10% change threshold between last two weeks (avoids noise for small fluctuations)
  - When adding new analytics RPC functions, update 3 places: frontend analytics.ts, frontend types.ts, MCP server api.ts+types.ts
  - lucide-react TrendingUp/TrendingDown/Minus icons work well for compact trend indicators next to stat values
  - YAxis width for training load chart needs more space (36px vs 24px) since load values can be 3-4 digits
  - When adding a new stat card to the dashboard, update the grid layout (sm:grid-cols-2 → sm:grid-cols-3) and test assertions for stat count
---

## 2026-02-06 - US-002 (Expanded Features)
- What was implemented: Injury severity tracking — optional severity scale (1-5) for injuries with form UI, color coding, weighted dashboard counts, and MCP server support
- Files changed:
  - frontend/supabase/migrations/20260206000001_add_injury_severity.sql - Migration adding severity column with CHECK constraint, and updated pain_flags_last_30_days RPC to return weighted_count (SUM of severity, defaulting to 1)
  - frontend/src/api/types.ts - Added severity to InjuryResponse, InjuryRequest, SessionInjuryRow; added weightedCount to PainFlagCount; added SEVERITY_LEVELS constant array; updated mapInjuryRow
  - frontend/src/api/sessions.ts - Added severity to injury insert maps in createSession and updateSession
  - frontend/src/api/analytics.ts - Updated painFlags mapping to include weighted_count → weightedCount
  - frontend/src/components/SessionForm.tsx - Added severity dropdown (ShadCN Select) to InjuryEntryRow with all 5 levels; severity state management; submit maps severity string to number or null
  - frontend/src/components/ui/select.tsx - ShadCN Select component (installed via CLI)
  - frontend/src/pages/SessionsPage.tsx - Added severityColor() (5 color variants green→red) and severityLabel() helpers; injury badges show severity number and have color coding + tooltip
  - frontend/src/pages/DashboardPage.tsx - Injuries section shows severity-weighted count when weightedCount > count
  - frontend/src/pages/EditSessionPage.tsx - Added severity to injury mapping in initialData
  - frontend/src/components/SessionForm.test.tsx - Added 3 tests: severity dropdown renders, pre-fills from initialData, submits null when not selected
  - frontend/src/pages/SessionsPage.test.tsx - Added 2 tests: severity color coding display, severity tooltip
  - frontend/src/pages/DashboardPage.test.tsx - Added 2 tests: weighted count display when higher, hidden when equal
  - frontend/src/pages/EditSessionPage.test.tsx - Updated mock injury with severity
  - mcp-server/src/types.ts - Added severity to InjuryResponse, InjuryRequest, SessionInjuryRow, PainFlagCount; updated mapInjuryRow
  - mcp-server/src/api.ts - Added severity to injury inserts; updated painFlags mapping with weighted_count
  - mcp-server/src/index.ts - Updated log_injury, log_session, list_injuries, get_training_summary for severity
- **Learnings for future iterations:**
  - ShadCN Select renders the selected value text in multiple DOM elements (trigger + hidden native select) — use getByLabelText + toHaveTextContent instead of getByText to test selected value
  - SEVERITY_LEVELS constant array defined in types.ts is shared between SessionForm (dropdown options) and SessionsPage (label display)
  - Severity-weighted injury count uses SUM(COALESCE(severity, 1)) so unrated injuries count as 1
  - When adding a new ShadCN component (Select), all @radix-ui peer deps are auto-installed
  - Injury severity color coding: green (1-Tweak) → yellow (2-Minor) → orange (3-Moderate) → red (4-Limiting) → dark red (5-Severe)
  - Total tests: 128 across 11 test files (up from ~122)
---

## 2026-02-06 - US-005 (Expanded Features)
- What was implemented: Replaced custom view toggle buttons with ShadCN Tabs component while keeping same List and CalendarDays icons
- Files changed:
  - frontend/src/components/ui/tabs.tsx - ShadCN Tabs component (installed via CLI)
  - frontend/src/pages/SessionsPage.tsx - Replaced Button-based toggle with Tabs/TabsList/TabsTrigger; removed useState import then re-added for controlled Tabs
  - frontend/src/pages/SessionsPage.test.tsx - Updated aria-pressed assertions to aria-selected (Radix Tabs attribute)
- **Learnings for future iterations:**
  - ShadCN Tabs uses Radix Tabs primitive which renders `role="tab"` with `aria-selected` (not `aria-pressed` like toggle buttons)
  - Controlled Tabs: use `value` and `onValueChange` props on `<Tabs>` for state management (needed for localStorage persistence)
  - TabsTrigger accepts children (including icons) and `title` attribute — existing test selectors by `title` still work
  - The `data-state="active"` attribute is also set on active TabsTrigger (alternative to aria-selected for testing)
  - Minimal change: only replaced the toggle buttons div, kept all conditional rendering logic below unchanged
---
